[![npm version](https://badge.fury.io/js/@wixc3%2Ftesting.svg)](https://badge.fury.io/js/@wixc3%2Ftesting)
[@wixc3/testing on Github](https://github.com/wixplosives/core3-utils/tree/master/packages/testing)

<!-- Do not edit this file. It is automatically generated by API Documenter. -->

[Home](https://wixplosives.github.io/core3-utils/index) &gt; [@wixc3/testing](https://wixplosives.github.io/core3-utils/testing)

## testing package

Utils for making mocha + chai testing easy and fun

## Remarks

### Steps

Steps are a convenient way to craft async tests. A step has a timeout and a description, making test timeouts easy to understand and debug. Each step timeout auto increases the test timeout, assuring the step will time out before the test

#### Available steps:

- [withTimeout()](https://wixplosives.github.io/core3-utils/testing.withtimeout) adds timeout and description to a promise

- [allWithTimeout()](https://wixplosives.github.io/core3-utils/testing.allwithtimeout) time limited Promise.all

- [waitForSpyCall()](https://wixplosives.github.io/core3-utils/testing.waitforspycall) spies on a method and wait for first call

- [waitForStubCall()](https://wixplosives.github.io/core3-utils/testing.waitforstubcall) creates a one off stub and wait for it to be called

- [step()](https://wixplosives.github.io/core3-utils/testing.step) adds a description (but not timeout) to a promise, useful for playwright locator waitFor

- [sleep()](https://wixplosives.github.io/core3-utils/testing.sleep) sleep (and adjust test time)

### Test timeout manipulation

- DEBUG=true env variable will set test timeouts and time dilation to infinity so tests (that don't explicitly override timeout) will not time out on breakpoints

- multiplies [step()](https://wixplosives.github.io/core3-utils/testing.step) timeouts when debugging or running on slow CI machines

- [adjustTestTime()](https://wixplosives.github.io/core3-utils/testing.adjusttesttime) adjusts current test timeout (for use in non step async actions)

- [locatorTimeout()](https://wixplosives.github.io/core3-utils/testing.locatortimeout) creates a locator timeout and adjust the current test

## Functions

| Function                                                                                                        | Description                                                                                                                                                                                                                |
| --------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [adjustTestTime(ms, allowTimeDilation)](https://wixplosives.github.io/core3-utils/testing.adjusttesttime)       | Add ms to current test timeout                                                                                                                                                                                             |
| [allWithTimeout(actions)](https://wixplosives.github.io/core3-utils/testing.allwithtimeout)                     | <p>Limits the time a list of promises can take</p><p>- Note: useable only within a mocha test/hook. The total test timeout will be adjusted to make sure the test will not time out waiting for this step</p>              |
| [createDisposalGroup(name, constraints)](https://wixplosives.github.io/core3-utils/testing.createdisposalgroup) | Creates a new disposal group                                                                                                                                                                                               |
| [defaults()](https://wixplosives.github.io/core3-utils/testing.defaults)                                        | default values for steps of the current test                                                                                                                                                                               |
| [disposeAfter(disposable, group)](https://wixplosives.github.io/core3-utils/testing.disposeafter)               | Disposes of test resources after the test is done                                                                                                                                                                          |
| [initAndDisposeAfter(target, args)](https://wixplosives.github.io/core3-utils/testing.initanddisposeafter)      | Runs target.init and disposes of it after the test is done \*                                                                                                                                                              |
| [locatorTimeout(ms)](https://wixplosives.github.io/core3-utils/testing.locatortimeout)                          | Creates a playwright locator options with timeout and adjust the current test timeout accordingly                                                                                                                          |
| [mochaCtx()](https://wixplosives.github.io/core3-utils/testing.mochactx)                                        | Active mocha context                                                                                                                                                                                                       |
| [randomizeTestsOrder(shouldRandomize)](https://wixplosives.github.io/core3-utils/testing.randomizetestsorder)   | <p>Randomizes tests order</p><p>To avoid confusion, it can only be set once, before the testing begins (i.e. not in a running test)</p>                                                                                    |
| [sleep(ms)](https://wixplosives.github.io/core3-utils/testing.sleep)                                            | Resolves after ms milliseconds                                                                                                                                                                                             |
| [step(action)](https://wixplosives.github.io/core3-utils/testing.step)                                          | <p>Adds a step description to a promise if it's rejected</p><p>\* - Note: useable only within a mocha test/hook. The total test timeout will be adjusted to make sure the test will not time out waiting for this step</p> |
| [timeDilation()](https://wixplosives.github.io/core3-utils/testing.timedilation)                                | <p>Get current test step time dilation</p><p>- All timeout set in tests will be multiplied by timeDilation()</p>                                                                                                           |
| [timeDilation(value)](https://wixplosives.github.io/core3-utils/testing.timedilation_1)                         | <p>Set current test step time dilation</p><p>- All timeout set in tests will be multiplied by timeDilation()</p>                                                                                                           |
| [useSafeFakeTimers()](https://wixplosives.github.io/core3-utils/testing.usesafefaketimers)                      | Makes it easy to safely use fake timers                                                                                                                                                                                    |
| [waitForSpyCall(scope, method)](https://wixplosives.github.io/core3-utils/testing.waitforspycall)               | Spies on an object method, waiting until it's called. The spy is removed once called                                                                                                                                       |
| [waitForStubCall(action, waitForAction)](https://wixplosives.github.io/core3-utils/testing.waitforstubcall)     | Creates a stub, then waits for it to be called                                                                                                                                                                             |
| [withTimeout(action)](https://wixplosives.github.io/core3-utils/testing.withtimeout)                            | <p>Limits the time a promise can take</p><p>- Note: useable only within a mocha test/hook. The total test timeout will be adjusted to make sure the test will not time out waiting for this step</p>                       |

## Interfaces

| Interface                                                                                  | Description                       |
| ------------------------------------------------------------------------------------------ | --------------------------------- |
| [Info](https://wixplosives.github.io/core3-utils/testing.info)                             | Step info base, added step errors |
| [PromiseStep](https://wixplosives.github.io/core3-utils/testing.promisestep)               |                                   |
| [PromiseWithTimeout](https://wixplosives.github.io/core3-utils/testing.promisewithtimeout) | WithTimeout API                   |
| [StepBase](https://wixplosives.github.io/core3-utils/testing.stepbase)                     | Common step props                 |
| [StepsDefaults](https://wixplosives.github.io/core3-utils/testing.stepsdefaults)           | Test step defaults                |
| [TimeoutDefaults](https://wixplosives.github.io/core3-utils/testing.timeoutdefaults)       | Step timeout defaults             |

## Variables

| Variable                                                                                           | Description |
| -------------------------------------------------------------------------------------------------- | ----------- |
| [DEFAULT_DISPOSAL_GROUP](https://wixplosives.github.io/core3-utils/testing.default_disposal_group) |             |

## Type Aliases

| Type Alias                                                                   | Description                                                                                                                       |
| ---------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| [Description](https://wixplosives.github.io/core3-utils/testing.description) | Sets step description                                                                                                             |
| [Predicate](https://wixplosives.github.io/core3-utils/testing.predicate)     | <p>A predicate function</p><p>Any return value other than \*\*false\*\* or throwing is considered as satisfying the predicate</p> |
| [Stub](https://wixplosives.github.io/core3-utils/testing.stub)               | A generated stub                                                                                                                  |
| [Timeout](https://wixplosives.github.io/core3-utils/testing.timeout)         | Sets step timeout                                                                                                                 |

## Chai Retry Plugin

Plugin that allows to re-run function passed to `expect` until the result will pass the chained assertion or timeout exceeded or retries limit reached.

### Usage

```ts
import Chai from 'chai';
import { chaiRetryPlugin } from '@wixc3/testing';

Chai.use(chaiRetryPlugin);
```

### Example

Just retrying function until it passes

```ts
let count = 0;
await expect(() => {
  if (count < 10) throw new Error('Failed. Try again');
  count++;
}).retry({ retries: 15, timeout: 2000, delay: 10 });
```

Retrying function and asserting result

```ts
let count = 0;
await expect(() => count++)
  .retry()
  .to.equal(4);
```

### Functions

| Function                         | Description                                                                             |
| -------------------------------- | --------------------------------------------------------------------------------------- |
| `.retry(options?: RetryOptions)` | Retrying function passed to `expect` according to passed options and chained assertions |

### Retry Options

| Option    | Description                                                                      | Default    |
| --------- | -------------------------------------------------------------------------------- | ---------- |
| `timeout` | The maximum duration in milliseconds to wait before failing the retry operation. | `5000`     |
| `retries` | The number of times to retry the function before failing.                        | `Infinity` |
| `delay`   | The delay in milliseconds between retries.                                       | `0`        |
